<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG 编辑器</title>

    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script async src="https://fastly.jsdelivr.net/npm/js-beautify@1.14.11/js/lib/beautify.min.js"></script>
    <script async src="https://fastly.jsdelivr.net/npm/js-beautify@1.14.11/js/lib/beautify-css.min.js"></script>
    <script async src="https://fastly.jsdelivr.net/npm/js-beautify@1.14.11/js/lib/beautify-html.min.js"></script>
    <link rel="stylesheet" href="svg.css">
    <script src="custom-toast.js"></script>
    <script src="shared.js"></script>
</head>

<body>
    <div class="wrapper" style="padding: 49px 0 49px 0;">
        <textarea id="textarea" style="font-size: 14px"></textarea>
    </div>
    <div class="bar-renderer top" style="top: 0;">
    </div>
    <div class="bar-renderer bottom">
    </div>
    <custom-toast id="toast"></custom-toast>
</body>

<script>

    let baseUri = window.location.host === "127.0.0.1:5500" ? "http://192.168.8.55:8090" : "..";
    const searchParams = new URL(window.location).searchParams;
    const id = searchParams.get('id');
    const path = searchParams.get('path');
    const textarea = document.getElementById("textarea");

    function insertItem(indexs, selector, klass) {
        const bottomBar = document.querySelector(selector);
        if (!bottomBar) return;
        bottomBar.innerHTML = '';
        const array = [];
        for (let j = 0; j < indexs.length; j++) {
            for (let index = 0; index < items.length; index++) {
                if (indexs[j] === items[index][0]) {
                    array.push(items[index]);
                    break;
                }
            }
        }
        array.filter(x => indexs.indexOf(x[0]) !== -1).forEach(x => {
            const div = document.createElement('div');
            div.className = klass || "item";
            div.innerHTML = `<span class="material-symbols-outlined">${x[1]}</span>
        <div class="pivot-bar-item-title">${x[2]}</div>`;
            div.addEventListener('click', evt => {
                evt.stopPropagation();
                x[3]();
            });
            bottomBar.appendChild(div);
        })
    }


    async function saveData() {
        let s = textarea.value.trim();
        let body = {
            id: id ? parseInt(id, 10) : 0,
            title: substringBefore(s, "\n").trim(),
            content: substringAfter(s, "\n").trim()
        };
        // await submitNote(getBaseUri(), JSON.stringify(body));
        // document.getElementById('toast').setAttribute('message', '成功');
        let res;
        try {
            res = await fetch(`${baseUri}/svg`, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            if (res.status !== 200) {
                throw new Error();
            }
            toast.setAttribute('message', '成功');
        } catch (error) {
            toast.setAttribute('message', '错误');
        }
    }

    async function loadData() {
        const res = await fetch(`${baseUri}/svg?id=${id}`);
        const body = await res.json();;
        document.title = body["title"];
        textarea.value = `${body["title"]}
    
${body["content"]}`;
    }

    function formatCode() {
        const options = { indent_size: 2 }
        textarea.value = html_beautify(textarea.value, options);
    }
    function getWord(textarea) {
        let start = textarea.selectionStart;
        let end = textarea.selectionEnd;
        while (start - 1 > -1 && /[a-zA-Z0-9_\u3400-\u9FBF]/.test(textarea.value[start - 1])) {
            start--;
        }
        while (end < textarea.value.length && /[a-zA-Z0-9_\u3400-\u9FBF]/.test(textarea.value[end])) {
            end++;
        }
        return [start, end];
    }

    function getLine(textarea) {
        let start = textarea.selectionStart;
        let end = textarea.selectionEnd;
        if (textarea.value[start] === '\n' && start - 1 > 0) {
            start--;
        }
        if (textarea.value[end] === '\n' && end - 1 > 0) {
            end--;
        }
        while (start - 1 > -1 && textarea.value[start - 1] !== '\n') {
            start--;
        }
        while (end + 1 < textarea.value.length && textarea.value[end + 1] !== '\n') {
            end++;
        }
        return [start, end + 1];
    }


    function findExtendPosition(editor) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        let string = editor.value;
        let offsetStart = start;
        while (offsetStart > 0) {
            if (!/\s/.test(string[offsetStart - 1]))
                offsetStart--;
            else {
                let os = offsetStart;
                while (os > 0 && /\s/.test(string[os - 1])) {
                    os--;
                }
                if ([...string.substring(offsetStart, os).matchAll(/\n/g)].length > 1) {
                    break;
                }
                offsetStart = os;
            }
        }
        let offsetEnd = end;
        while (offsetEnd < string.length) {
            if (!/\s/.test(string[offsetEnd + 1])) {

                offsetEnd++;
            } else {

                let oe = offsetEnd;
                while (oe < string.length && /\s/.test(string[oe + 1])) {
                    oe++;
                }
                if ([...string.substring(offsetEnd, oe + 1).matchAll(/\n/g)].length > 1) {
                    offsetEnd++;

                    break;
                }
                offsetEnd = oe + 1;

            }
        }
        while (offsetStart > 0 && string[offsetStart - 1] !== '\n') {
            offsetStart--;
        }
        // if (/\s/.test(string[offsetEnd])) {
        //     offsetEnd--;
        // }
        return [offsetStart, offsetEnd];
    }
    async function snippet(textarea) {
        const points = getWord(textarea);
        let word = textarea.value.substring(points[0], points[1]);

        const res = await fetch(`${baseUri}/snippet?k=${word}&t=0`)
        if (res.status === 200) {
            textarea.setRangeText(await res.text(), points[0], points[1]);
        }
    }
    function commentLine(textarea) {
        const points = findExtendPosition(textarea);
        let s = textarea.value.substring(points[0], points[1]).trim();
        if (s.startsWith("<!--") && s.endsWith("-->")) {
            s = s.substring("<!--".length);
            s = s.substring(0, s.length - "-->".length);
        } else {
            s = `<!--${s}-->`;
        }
        textarea.setRangeText(s, points[0], points[1]);
    }
    async function initializeToolbars() {
        let topIndexs;
        let bottomIndexs;

        try {
            const response = await fetch(`${baseUri}/ts`);
            if (response.status > 399 || response.status < 200) {
                throw new Error(`${response.status}: ${response.statusText}`)
            }
            const results = JSON.parse(await response.text());
            if (results) {
                topIndexs = results[0];
                bottomIndexs = results[1];
            }
        } catch (error) {
            topIndexs = [1, 6, 7, 4]
            bottomIndexs = [2, 3, 5]
        }
        insertItem(topIndexs, '.bar-renderer.top', 'bar-item-tab');
        insertItem(bottomIndexs, '.bar-renderer.bottom', 'bar-item-tab');
    }
    ///////////////////////////////////////////////////
    const items = [
        [
            1,
            "preview",
            "预览",
            () => {
                window.open(`${baseUri}/svgviewer?id=${id}`, '_blank');
            }
        ], [
            2,
            "save",
            "保存",
            async () => {
                saveData();
            }
        ], [
            3,
            "code",
            "格式",
            () => {
                formatCode();
            }
        ], [
            4,
            "help",
            "帮助",
            () => {
                window.open(`${baseUri}/snippet.html`, '_blank');
            }
        ],
        [
            5,
            "text_snippet",
            "代码",
            () => {
                snippet(textarea);
            }
        ], [
            6,
            "text_snippet",
            "计算",
            () => {
                let points = getLine(textarea);
                let line = textarea.value.substring(points[0], points[1]);
                textarea.setRangeText(eval(line), points[0], points[1])
            }
        ], [
            7,
            "comment",
            "注释",
            () => {
                commentLine(textarea)
            }
        ],
    ];
    document.addEventListener('keydown', async evt => {
        if (evt.ctrlKey) {
            if (evt.key === 's') {
                evt.preventDefault();
                await saveData();
            }
        }

    })
    initializeToolbars()
    loadData();
</script>

</html>