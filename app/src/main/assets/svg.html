<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG 编辑器</title>

    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script async src="https://fastly.jsdelivr.net/npm/js-beautify@1.14.11/js/lib/beautify.min.js"></script>
    <script async src="https://fastly.jsdelivr.net/npm/js-beautify@1.14.11/js/lib/beautify-css.min.js"></script>
    <script async src="https://fastly.jsdelivr.net/npm/js-beautify@1.14.11/js/lib/beautify-html.min.js"></script>
    <link rel="stylesheet" href="svg.css">
    <script src="custom-toast.js"></script>
    <script src="shared.js"></script>
</head>

<body>
    <div class="wrapper" style="padding: 49px 0 49px 0;">
        <textarea id="textarea" style="font-size: 14px"></textarea>
    </div>
    <div class="bar-renderer top" style="top: 0;">
    </div>
    <div class="bar-renderer bottom">
    </div>
    <custom-toast id="toast"></custom-toast>
</body>

<script>

    let baseUri = window.location.host === "127.0.0.1:5500" ? "http://192.168.8.55:8090" : "..";
    const searchParams = new URL(window.location).searchParams;
    const id = searchParams.get('id');
    const path = searchParams.get('path');
    const textarea = document.getElementById("textarea");

    function insertItem(indexs, selector, klass) {
        const bottomBar = document.querySelector(selector);
        if (!bottomBar) return;
        bottomBar.innerHTML = '';
        const array = [];
        for (let j = 0; j < indexs.length; j++) {
            for (let index = 0; index < items.length; index++) {
                if (indexs[j] === items[index][0]) {
                    array.push(items[index]);
                    break;
                }
            }
        }
        array.filter(x => indexs.indexOf(x[0]) !== -1).forEach(x => {
            const div = document.createElement('div');
            div.className = klass || "item";
            div.innerHTML = `<span class="material-symbols-outlined">${x[1]}</span>
        <div class="pivot-bar-item-title">${x[2]}</div>`;
            div.addEventListener('click', evt => {
                evt.stopPropagation();
                x[3]();
            });
            bottomBar.appendChild(div);
        })
    }


    async function saveData() {
        let s = textarea.value.trim();
        let nid = id ? parseInt(id, 10) : 0;
        let body = {
            id: nid,
            title: substringBefore(s, "\n").trim(),
            content: substringAfter(s, "\n").trim()
        };
        // await submitNote(getBaseUri(), JSON.stringify(body));
        // document.getElementById('toast').setAttribute('message', '成功');
        let res;
        try {
            res = await fetch(`${baseUri}/svg`, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            if (res.status !== 200) {
                throw new Error();
            }
            if (!nid) {
                var queryParams = new URLSearchParams(window.location.search);
                queryParams.set("id", await res.text());
                history.replaceState(null, null, "?" + queryParams.toString());
            }
            toast.setAttribute('message', '成功');
        } catch (error) {
            toast.setAttribute('message', '错误');
        }
    }

    async function loadData() {
        const res = await fetch(`${baseUri}/svg?id=${id}`, { cache: "no-store" });
        const body = await res.json();;
        document.title = body["title"];
        textarea.value = `${body["title"]}
    
${body["content"]}`;
    }

    function formatCode() {
        const options = { indent_size: 2 }
        textarea.value = html_beautify(textarea.value, options);
    }
    function getWord(textarea) {
        let start = textarea.selectionStart;
        let end = textarea.selectionEnd;
        while (start - 1 > -1 && /[a-zA-Z0-9_\u3400-\u9FBF]/.test(textarea.value[start - 1])) {
            start--;
        }
        while (end < textarea.value.length && /[a-zA-Z0-9_\u3400-\u9FBF]/.test(textarea.value[end])) {
            end++;
        }
        return [start, end];
    }

    function getLine(textarea) {
        let start = textarea.selectionStart;
        let end = textarea.selectionEnd;
        if (textarea.value[start] === '\n' && start - 1 > 0) {
            start--;
        }
        if (textarea.value[end] === '\n' && end - 1 > 0) {
            end--;
        }
        while (start - 1 > -1 && textarea.value[start - 1] !== '\n') {
            start--;
        }
        while (end + 1 < textarea.value.length && textarea.value[end + 1] !== '\n') {
            end++;
        }
        return [start, end + 1];
    }


    function findExtendPosition(editor) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        let string = editor.value;
        let offsetStart = start;
        while (offsetStart > 0) {
            if (!/\s/.test(string[offsetStart - 1]))
                offsetStart--;
            else {
                let os = offsetStart;
                while (os > 0 && /\s/.test(string[os - 1])) {
                    os--;
                }
                if ([...string.substring(offsetStart, os).matchAll(/\n/g)].length > 1) {
                    break;
                }
                offsetStart = os;
            }
        }
        let offsetEnd = end;
        while (offsetEnd < string.length) {
            if (!/\s/.test(string[offsetEnd + 1])) {

                offsetEnd++;
            } else {

                let oe = offsetEnd;
                while (oe < string.length && /\s/.test(string[oe + 1])) {
                    oe++;
                }
                if ([...string.substring(offsetEnd, oe + 1).matchAll(/\n/g)].length > 1) {
                    offsetEnd++;

                    break;
                }
                offsetEnd = oe + 1;

            }
        }
        while (offsetStart > 0 && string[offsetStart - 1] !== '\n') {
            offsetStart--;
        }
        // if (/\s/.test(string[offsetEnd])) {
        //     offsetEnd--;
        // }
        return [offsetStart, offsetEnd];
    }
    async function snippet(textarea) {
        const points = getWord(textarea);
        let word = textarea.value.substring(points[0], points[1]);

        const res = await fetch(`${baseUri}/snippet?k=${word}&t=0`, { cache: "no-store" })
        if (res.status === 200) {
            textarea.setRangeText(await res.text(), points[0], points[1]);
        }
    }
    function commentLine(textarea) {
        const points = findExtendPosition(textarea);
        let s = textarea.value.substring(points[0], points[1]).trim();
        if (s.startsWith("<!--") && s.endsWith("-->")) {
            s = s.substring("<!--".length);
            s = s.substring(0, s.length - "-->".length);
        } else {
            s = `<!--${s}-->`;
        }
        textarea.setRangeText(s, points[0], points[1]);
    }
    function animateShape(selectedString) {
        let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.innerHTML = selectedString;
        svg.style.position = 'absolute';
        svg.style.left = '-100%';
        document.body.appendChild(svg);

        var len = svg.children[0].getTotalLength();
        svg.remove();
        return `
${substringBefore(selectedString, '>')} 
fill="none" 
stroke="red" 
stroke-width="4"
stroke-dasharray="${len}"
stroke-dashoffset="${len}" >
<animate id="" 
begin="1s" 
attributeName="stroke-dashoffset" 
values="${len};0" 
dur="1s" 
calcMode="linear" 
fill="freeze"/>
</${selectedString.match(/(?<=<)[^ ]+/)}>
`;
    }
    function animatePath(selectedString) {
        let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', selectedString);
        svg.appendChild(path);
        svg.style.position = 'absolute';
        svg.style.left = '-100%';
        document.body.appendChild(svg);

        var len = path.getTotalLength();
        svg.remove();
        return `
<path d="${selectedString}" 
fill="none" 
stroke="red" 
stroke-width="4"
stroke-dasharray="${len}"
stroke-dashoffset="${len}" >
<animate id="" 
begin="1s" 
attributeName="stroke-dashoffset" 
values="${len};0" 
dur="1s" 
calcMode="linear" 
fill="freeze"/>
</path>
`;
    }
    function drawPolygon(x, y, n, radius, options = {}) {
        const array = [];
        array.push(
            [x + radius * Math.cos(options.rotation || 0),
            y + radius * Math.sin(options.rotation || 0)]);
        for (let i = 1; i <= n; i += 1) {
            const angle = (i * (2 * Math.PI / n)) + (options.rotation || 0);
            array.push(
                [
                    x + radius * Math.cos(angle),
                    y + radius * Math.sin(angle)
                ])
        }
        const d = `M${array.map(x => `${x[0]} ${x[1]}`).join('L')}`;
        return `<path stroke="#FF5722" fill="none" stroke-width="4"  d="${d}">
</path>`
    }
    function getTotalLength(d) {
        let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', d);
        svg.appendChild(path);
        svg.style.position = 'absolute';
        svg.style.left = '-100%';
        document.body.appendChild(svg);

        var len = path.getTotalLength();
        svg.remove();
        return len;
    }
    function getBBox(s, isLen) {
        let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.innerHTML = s;
        svg.style.position = 'absolute';
        svg.style.left = '-100%';
        document.body.appendChild(svg);

        var len = isLen ? svg.children[0].getTotalLength() : svg.children[0].getBBox();
        svg.remove()
        return len;
    }
    function getCenterPath(s, offset) {
        let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.innerHTML = s;
        svg.style.position = 'absolute';
        svg.style.left = '-100%';
        document.body.appendChild(svg);

        var len = svg.children[0].getTotalLength();
        let first = svg.children[0].getPointAtLength(len / 2 - offset)
        let second = svg.children[0].getPointAtLength(len / 2 + offset)

        svg.remove()
        return [first, second];
    }
    function getNormalPath(s, offset) {
        let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.innerHTML = s;
        svg.style.position = 'absolute';
        svg.style.left = '-100%';
        document.body.appendChild(svg);

        var len = svg.children[0].getTotalLength();
        let firstPoint = svg.children[0].getPointAtLength(0)
        let secondPoint = svg.children[0].getPointAtLength(len)
        var deg = Math.atan2(firstPoint.y - secondPoint.y, firstPoint.x - secondPoint.x) * (180 / Math.PI);
        deg = 180 - deg;
        var offsetX = Math.sin(deg / Math.PI * 180) * offset;
        var offsetY = Math.cos(deg / Math.PI * 180) * offset;

        svg.remove()
        return `M${firstPoint.x + offsetX} ${firstPoint.y + offsetY}L${secondPoint.x + offsetX} ${secondPoint.y + offsetY}`;
    }
    function calculateMoveAlongNormalPath(s) {
        let offset = substringBefore(s, "<path").trim();
        let path = "<path" + substringAfter(s, "<path");
        let v = getNormalPath(path, parseInt(offset))
        return s.replace(/(?<=d=")[^"]+(?=")/, v);
    }
    function calculateCenterTextPath(s) {
        let path = substringBefore(s, "<text");
        let text = "<text" + substringAfter(s, "<text");
        let box = getBBox(text, false);
        const points = getCenterPath(path, box.width / 2);
        const first = points[0];
        const second = points[1];
        let v = `M${first.x} ${first.y}L${second.x} ${second.y}`
        return `<defs>
    <path
      id="tp1"
      fill="none"
      stroke="red"
      d="${v}" />
    </defs>
  
  

    <text font-size="36px" font-family="苹方">
      <textPath href="#tp1" startOffset="-100%">${s.match(/(?<=>)[^<]+(?=<\/text)/)}
      <animate attributeName="startOffset" from="-100%" to ="0%" begin="0s" dur="1s" repeatCount="1" id="t1" fill="freeze"/>
      </textPath>
    </text>
    
    `

        //s.replace(/(?<=d=")[^"]+(?=")/, v);
    }
    function processSelection(fn) {
        let selectionStart = textarea.selectionStart;
        let selectionEnd = textarea.selectionEnd;
        let selectedString = textarea.value.substring(selectionStart, selectionEnd);
        if (!selectedString) {
            selectedString = getLine(textarea);
            if (textarea.value[selectionStart] !== '\n') {
                while (selectionStart + 1 < textarea.value.length && textarea.value[selectionStart + 1] !== '\n') {
                    selectionStart++;
                }
                selectionStart++;
            }

            selectionEnd = selectionStart
            textarea.value = `${textarea.value.substring(0, selectionStart)}
${fn(selectedString.trim())}${textarea.value.substring(selectionEnd)}`;
            return;
        }
        textarea.value = `${textarea.value.substring(0, selectionStart)}${fn(selectedString.trim())}${textarea.value.substring(selectionEnd)}`;

    }
    function calculate() {

        processSelection(s => {
            if (s.indexOf('<path') !== -1 &&
                s.indexOf('<text') !== -1) {
                return calculateCenterTextPath(s)
            } else if (/^[0-9]+<path/.test(s)) {
                return calculateMoveAlongNormalPath(s)
            } else if (/\d+,\d+,\d+,\d+/.test(s)) {
                return eval(`drawPolygon(${s})`);
            } else {
                return eval(s);
            }
        })
    }
    async function initializeToolbars() {
        let topIndexs;
        let bottomIndexs;

        try {
            const response = await fetch(`${baseUri}/ts`);
            if (response.status > 399 || response.status < 200) {
                throw new Error(`${response.status}: ${response.statusText}`)
            }
            const results = JSON.parse(await response.text());
            if (results) {
                topIndexs = results[0];
                bottomIndexs = results[1];
            }
        } catch (error) {
            topIndexs = [1, 6, 7, 8, 4]
            bottomIndexs = [2, 3, 5]
        }
        insertItem(topIndexs, '.bar-renderer.top', 'bar-item-tab');
        insertItem(bottomIndexs, '.bar-renderer.bottom', 'bar-item-tab');
    }
    ///////////////////////////////////////////////////
    const items = [
        [
            1,
            "preview",
            "预览",
            () => {
                window.open(`${baseUri}/svgviewer?id=${id}`, '_blank');
            }
        ], [
            2,
            "save",
            "保存",
            async () => {
                saveData();
            }
        ], [
            3,
            "code",
            "格式",
            () => {
                formatCode();
            }
        ], [
            4,
            "help",
            "帮助",
            () => {
                window.open(`${baseUri}/snippet.html`, '_blank');
            }
        ],
        [
            5,
            "text_snippet",
            "代码",
            () => {
                snippet(textarea);
            }
        ], [
            6,
            "text_snippet",
            "计算",
            () => {
                let points = getLine(textarea);
                let line = textarea.value.substring(points[0], points[1]);
                textarea.setRangeText(eval(line), points[0], points[1])
            }
        ], [
            7,
            "comment",
            "注释",
            () => {
                commentLine(textarea)
            }
        ], [
            8,
            "animation",
            "动画",
            () => {
                calculate()
            }
        ],
    ];
    document.addEventListener('keydown', async evt => {
        if (evt.ctrlKey) {
            if (evt.key === 's') {
                evt.preventDefault();
                await saveData();
            }
        } else {
            if (evt.key === 'F1') {
                evt.preventDefault();
                snippet(textarea);
            }
        }

    })
    initializeToolbars()
    loadData();
</script>

</html>